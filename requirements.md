# 往診ルート最適化システム 要件定義書

## 1. システム概要

### 目的
往診医療における医師のルート設計を支援し、全体の診療終了時間を最小化しつつ移動距離を削減するシステム。複数医師体制（モック: 2～3名、本番: 十数人程度）での効率的な往診運営を実現する。

### 運用形態
- **クラウド運用**: システムはクラウド上にデプロイし、医師がブラウザ等からログインして利用する。
- **集中管理**: 全医師・全患者データを一元的に管理する設計。医師が各自のルート確認・操作を行う。

### 対象ユーザー
- **医師のみ**がシステムを利用する。ルート確認・スケジュール確認・緊急割り振り確認等を医師が自ら行う。
- **患者は利用しない**。患者は登録データとしてのみ存在し、患者自身がログインしたりシステムにアクセスすることは想定しない。

---

## 2. 運用前提条件

### 診療スケール
| 項目 | 仕様 |
|------|------|
| 1医師あたりの日想定件数 | 4～10宅 |
| 医師数（モック） | 2～3名（開発・検証・デモ用） |
| 医師数（本番） | 十数人程度（実運用想定） |
| 患者割り当て | 固定制（医師間での入れ替えなし） |

### アクセス方式・運用形態
- **クラウド型**: クラウド上にホストされたアプリに医師がログインして利用
  - 管制塔1台のPCで、全医師のスケジュール・ルート計算・緊急対応を集中して操作
  - 複数医師が同時にアクセスして利用する想定
- **マルチアクセス対応**: 医師複数名の同時利用を前提とする

### 往診で守るべき制約（必須要件）
| 制約 | 内容 |
|------|------|
| **NG医師** | 患者ごとに「この先生では診てほしくない」を設定可能。ルート計算・緊急割り振りでは必ず遵守する。 |
| **希望訪問時間帯** | 「この時間で来ないといけない」希望がある患者の時間帯を登録。計算結果がその時間帯を満たすようにする。 |
| **緊急の割り振り** | 緊急往診が入った際、**最短かつ上記条件（NG医師・希望時間等）を満たす**医師を選定するプログラムで割り振りを決定する。 |
| **医師ルート生成** | 各医師の巡回順序に加え、可能であれば地図上のルート・案内（経路）を生成する。 |
| **終了時間の平準化** | 全医師の診療終了時刻がなるべく同じになるようにスケジュールを組む（負荷の偏りを防ぐ）。 |

---

## 3. コア機能要件

### 3-1. 患者・医師情報の登録
#### 入力情報
- **患者情報**
  - 患者ID
  - 患者氏名（機密情報）
  - 住所（緯度経度で管理、機密情報）
  - 電話番号（機密情報、任意）
  - 診察推定所要時間（分単位）
  - 担当医師（デフォルト割り当て医師）
  - **NG医師**（割り当て禁止医師のリスト。この患者には絶対に割り当てない）
  - **希望訪問時間帯**（任意。「この時間で来ないといけない」希望がある場合、開始希望時刻または時間帯範囲を登録）
  - 登録日時
  - 更新日時

- **医師情報**
  - 医師ID
  - 医師氏名
  - 担当患者リスト
  - 現在地（初期値：医療機関所在地）
  - 登録日時
  - 更新日時

#### データ保持方式
- **データベース**: クラウド運用ではマネージドDB（PostgreSQL / MySQL 等）または SQLite（クラウドボリューム上）。SQLite 利用時は SQLCipher による暗号化を検討。
- **暗号化方式**: AES-256
- **機密情報の扱い**:
  - 患者氏名、住所、電話番号は個別に暗号化して保存
  - 患者ID、診察時間、担当医師は暗号化不要（非機密情報）
  - データベースファイル全体もSQLCipherで暗号化
- **保存場所**: クラウド上のデータベース（マネージドDB または クラウドストレージ）
- **アクセス制御**: クラウド認証（医師アカウントによるログイン）。API・DB へのアクセスは認証済みユーザーのみ。

#### データ永続化要件
- **バックアップ**:
  - 日次自動バックアップ（診療終了後、または深夜に実行）
  - バックアップファイルも暗号化状態で保存
  - バックアップ先: クラウドストレージ（同一リージョンまたは別リージョン）
  - バックアップ保持期間: 30日間（設定可能）
- **データ移行**:
  - CSV/JSON形式でのエクスポート機能（暗号化解除後の出力）
  - エクスポート時は管理者権限が必要
  - インポート機能（既存データの一括登録用）
- **データ保持期間**:
  - 患者情報: 診療終了後、設定可能な期間（デフォルト: 1年）
  - 計算履歴: 3ヶ月間保持（設定可能）
- **データ削除**:
  - 保持期間経過後の自動削除機能（オプション）
  - 手動削除機能（管理者権限が必要）
  - 削除操作は監査ログに記録

### 3-2. ルート最適化計算

#### 計算トリガー（自動計算）
1. **朝一計算**: 診療開始時に自動実行
2. **昼計算**: 午後診療開始時に自動実行（任意で有効化可能）
3. **緊急割り込み計算**: 臨時往診が登録された際に自動実行

#### 守るべき制約（必須）
- **NG医師の遵守**: 患者に設定された「割り当て禁止医師」には、その患者を絶対に割り当てない。
- **希望訪問時間帯の遵守**: 「この時間で来ないといけない」希望がある患者には、計算結果の到着時刻がその時間帯内に収まるようにする。

#### 計算アルゴリズムの考慮要素
- **移動時間**: 患者住所間の移動時間（Google Maps API等）
- **診察時間**: 各患者の診察推定所要時間
- **全体終了時間**: 全医師が診察を終わる最後の時刻
- **移動効率**: 総移動距離の最小化
- **終了時間の平準化**: **全員の診療終了時刻がなるべく同じになるように**スケジュールを組む（特定の医師だけ遅くならないように負荷を均す）。

#### 出力内容
- 各医師に対して**推奨巡回順序**を提示（ルート生成）。可能であれば地図上の経路・案内も出力する。
```
医師A:
  1. 患者① → 移動時間5分 → 診察時間15分 [到着 9:05]
  2. 患者③ → 移動時間8分 → 診察時間20分 [到着 9:48]
  3. 患者⑤ → 移動時間6分 → 診察時間15分 [到着 10:24]
  全体終了予定時刻: 10:39

医師B:
  1. 患者② → 移動時間3分 → 診察時間10分 [到着 9:13]
  2. 患者④ → 移動時間10分 → 診察時間18分 [到着 9:41]
  全体終了予定時刻: 10:39
```
（例: 終了時刻を 10:39 に揃えた場合）

#### 計算履歴の保存
- 計算実行日時、実行ユーザー、計算結果を保存
- 計算結果はJSON形式で保存（暗号化不要）
- 過去の計算結果の参照機能

### 3-3. 緊急往診の対応

#### 入力方式
- **手入力**: 医師（または管理者）が新規患者情報を画面から入力
  - 患者住所
  - 診察推定所要時間
  - 優先度（緊急/通常）
  - **NG医師**（あれば設定）
  - **希望訪問時間帯**（あれば設定）

#### 緊急割り振り決定プログラム
- 緊急往診が入った際、**どの医師に割り振るかをシステムが自動で提案**する。
- **条件**: 最短（全体終了時間の悪化が最小）かつ、**NG医師・希望時間帯などの制約を満たす**医師を選定する。
- 候補医師ごとに「割り振った場合の終了時刻」「制約充足の有無」を表示し、ユーザーが最終確認して医師に指示する。

#### 処理フロー
1. 緊急患者情報（住所・診察時間・NG医師・希望時間帯など）を入力
2. 割り振りプログラムが、条件を満たす医師のうち「最短で対応できる」案を算出
3. 候補医師とスケジュール案を提示し、ユーザーが確認して医師に指示
4. 必要に応じて現在スケジュール + 新規患者で再計算（終了時間平準化を考慮）
5. 緊急対応の記録を監査ログに保存

---

## 4. セキュリティ要件

### 4-1. データ暗号化
- **データベース全体**: SQLCipherによるAES-256暗号化
- **機密情報カラム**: 患者氏名、住所、電話番号を個別にAES-256暗号化
- **暗号化キー管理**: 
  - マスターパスワード方式（初回起動時に設定）
  - キーは環境変数または設定ファイルで管理（設定ファイルも暗号化）
  - キーの定期ローテーション機能（将来実装）

### 4-2. アクセス制御
- **クラウド認証**: 医師アカウントによるログイン（ID/パスワードまたはSSO等）
- **アプリケーションレベル**: 
  - 医師向け: 自分のルート・スケジュールの閲覧、計算実行・緊急割り振り確認
  - 管理者ロール（必要に応じて）: 患者・医師情報の登録・更新、データ削除、エクスポート、設定変更
- **操作権限**:
  - 閲覧権限: 計算結果の表示（自担当分または全体）
  - 編集権限: 患者・医師情報の登録・更新（権限を持つユーザーのみ）
  - 管理者権限: データ削除、エクスポート、設定変更

### 4-3. 監査ログ
- **記録対象操作**:
  - 患者情報の登録・更新・削除
  - 医師情報の登録・更新・削除
  - ルート計算の実行
  - 緊急往診の登録
  - データエクスポート
  - データ削除
  - 設定変更
- **記録内容**:
  - 操作日時
  - 実行ユーザー（医師IDまたは管理者ID）
  - 操作種別
  - 対象データ（患者ID、医師ID等、機密情報は含めない）
- **ログ保存**:
  - 別のSQLiteデータベースに保存（暗号化）
  - ログの改ざん防止（ハッシュ値による整合性チェック）
  - ログ保持期間: 1年間（設定可能）

### 4-4. ネットワークセキュリティ
- **クラウド運用**: すべての通信はHTTPSで暗号化
- 必要に応じてVPNまたはプライベートネットワークで接続制限可能
- API・アプリはクラウド上のセキュアな環境で稼働

### 4-5. 物理・クラウドセキュリティ
- データベース・アプリはクラウドプロバイダのマネージドサービス上に配置
- データセンターの物理セキュリティはプロバイダに依存
- 医師端末の画面ロック・セッションタイムアウトの推奨

---

## 5. システム構成（フェーズ1: PoC）

### 5-1. ユーザーインターフェース
- **医師向けWeb画面**: クラウド上のアプリに医師がログインして利用
  - 医師・患者情報の入力フォーム（**NG医師**・**希望訪問時間帯**の設定を含む。権限を持つユーザーのみ）
  - ルート最適化計算の実行
  - 計算結果の表示（医師ごとのスケジュール・巡回順序。可能なら地図上のルート表示）
  - 緊急往診入力フォーム（NG医師・希望時間帯入力可）と**緊急割り振り提案**の表示
  - 計算履歴表示
  - バックアップ実行（手動または自動。管理者権限の場合）

### 5-2. バックエンド処理
- 移動時間計算: Google Maps API（Distance Matrix API）
- ルート最適化: 
  - 簡易版: 貪欲法または割り当てヒューリスティクス
  - 将来: メタヒューリスティクス（遺伝的アルゴリズム等）
- データ保持: クラウド上のマネージドDB または SQLite（SQLCipher）
- 暗号化処理: Python cryptography ライブラリまたは同等

### 5-3. 技術スタック（案）
| レイヤー | 技術 |
|---------|------|
| フロントエンド | HTML/CSS/JavaScript（単一 SPA） |
| バックエンド | Python/Flask |
| データベース | クラウド: マネージドDB（PostgreSQL等） / または SQLite + SQLCipher（クラウドボリューム） |
| 暗号化ライブラリ | Python cryptography または pysqlcipher3 |
| 地図・移動時間 | Google Maps API |
| ホスティング | クラウド（AWS / GCP / Azure 等のいずれか、またはPaaS） |

---

## 6. 将来拡張機能（FY2026年末以降を想定）

### Phase 2 機能
- [ ] 複数ユーザー同時アクセス対応（リアルタイム共有）
- [ ] 医師のリアルタイム位置情報取得（GPS連携）
- [ ] 実績ベースの診察時間学習（過去実績から自動推定）
- [ ] 移動手段の選択（車/バイク/徒歩等）
- [ ] 天候や交通状況の動的反映
- [ ] ユーザー認証システム（ロールベースアクセス制御）
- [ ] 暗号化キーの定期ローテーション

### Phase 3 機能
- [ ] モバイルアプリ化（医師側の確認画面）
- [ ] 患者情報連携（EHR システムとの統合）
- [ ] 診療履歴の蓄積と分析
- [ ] クラウドバックアップ（暗号化状態で）

---

## 7. 実装ロードマップ

| 時期 | マイルストーン | 成果物 |
|------|----------------|--------|
| 2026年1月～2月 | 要件確定・設計 | 詳細設計書、画面ワイヤーフレーム |
| 2026年3月 | 開発・PoC実装 | 動作確認版システム |
| 2026年3月下旬～ | 実際の運用データで検証 | 精度改善、UI フィードバック |
| 2026年4月～ | 本格運用開始 | Phase 2 計画立案 |

---

## 8. 技術的検討事項

### 8-1. ルート最適化アルゴリズムの選択
**PoC 段階の推奨**: 制約付きヒューリスティクス
- **制約の優先**: NG医師・希望訪問時間帯は必ず満たす。満たせない組み合わせは解から除外。
- **目的**: 全医師の終了時刻をなるべく揃えつつ、総移動時間・全体終了時刻を最小化。
- 各医師に対して「次に対応すべき患者」を、制約を満たす範囲で貪欲に選択（終了時刻の平準化を考慮）。
- 計算量が少なく、レスポンス時間が短い。結果の説明性が高い（ユーザーが納得しやすい）。

**将来的検討**: より高度な最適化
- 巡回セールスマン問題（TSP）の応用
- 遺伝的アルゴリズムやシミュレーテッド・アニーリング
- 医師ルートの地図・経路案内の高機能化

### 8-2. 移動時間データの精度
- **初版**: Google Maps Distance Matrix API を信頼
- **改善案**: 実績データ（実際の移動時間）をログして、推定値の精度向上

### 8-3. オフライン対応
- インターネット接続が不安定な環境への対応
- ローカル キャッシュの活用
- 移動時間データのキャッシュ機能

### 8-4. 暗号化実装の詳細
- **SQLCipherの利用**:
  - Python: `pysqlcipher3` または `sqlcipher3`
  - データベース接続時にパスワードを指定
  - パスワードは環境変数または暗号化された設定ファイルから取得
- **カラム単位暗号化**:
  - `cryptography` ライブラリの `Fernet` を使用
  - 暗号化キーはマスターパスワードから派生（PBKDF2）
- **パフォーマンス考慮**:
  - 頻繁にアクセスする非機密情報は暗号化しない
  - 機密情報は必要時のみ復号化

---

## 9. 成功指標（KPI）

| KPI | 目標値 |
|-----|--------|
| 全体診療終了時間の短縮 | 従来比 5～15% 削減 |
| 終了時間の平準化 | 全医師の終了時刻のばらつきを最小化（目標: 同一時刻に近づける） |
| 医師の移動距離削減 | 従来比 10～20% 削減 |
| 制約遵守 | NG医師・希望訪問時間帯の違反 0件 |
| 緊急対応時間 | 情報入力～割り振り提案・ルート提示：1分以内 |
| システムレスポンス時間 | 計算実行：5秒以内 |
| データバックアップ成功率 | 100% |
| セキュリティインシデント | 0件 |

---

## 10. 留意事項・制約

### 運用上の制約
- **患者の医師間入れ替えなし**: 既存の患者－医師関係を保持（NG医師でない限り担当は固定）
- **制約の厳守**: NG医師・希望訪問時間帯はルート計算・緊急割り振りで必ず守る
- **手入力ベース**: 自動位置情報取得は未実装
- **利用者は医師のみ**: 患者はシステムを利用しない。医師がクラウド経由でアクセスして利用する。
- **クラウド運用**: アプリ・DBはクラウド上に配置。医師数はモック2～3名、本番十数人を想定。

### 技術的制約
- Google Maps API の無料枠制限（将来的にはコスト考慮）
- 移動時間推定の精度（リアルタイム交通情報未取得）
- クラウドリソースのスケールとコストのバランス
- マネージドDBの同時接続・書き込み制限（必要に応じてスケール設定）

### セキュリティ上の制約
- マスターパスワードの紛失はデータ復旧不可（バックアップ必須）
- 暗号化キーの管理は運用者の責任
- クラウドリソースへのアクセスはIAM・ネットワークポリシーで制御

### 法的・コンプライアンス要件
- 個人情報保護法への準拠
- 医療情報の適切な管理（医療機関の情報管理指針に準拠）
- データ保持期間の明確化
- 患者への情報開示請求への対応（エクスポート機能で対応）

---

## 11. エラーハンドリング

### 11-1. Google Maps API エラー
- **API制限エラー**: 
  - リトライ機能（最大3回、指数バックオフ）
  - エラーメッセージをユーザーに表示
  - キャッシュされた移動時間データがあれば使用
- **ネットワークエラー**:
  - タイムアウト設定（30秒）
  - エラー時は手動で移動時間を入力可能にする
- **APIキーエラー**:
  - 設定画面でAPIキーの再設定を促す

### 11-2. データベースエラー
- **接続エラー**: 
  - データベースファイルの存在確認
  - パスワードエラーの場合は再入力画面を表示
- **整合性エラー**:
  - トランザクションロールバック
  - エラーログに記録
  - ユーザーに通知

### 11-3. 入力バリデーション
- **必須項目チェック**: 患者ID、住所、診察時間
- **データ型チェック**: 数値、日時形式
- **範囲チェック**: 診察時間（1分～120分）、緯度経度範囲、希望時間帯の開始＜終了
- **重複チェック**: 患者ID、医師IDの一意性
- **制約整合性**: 担当医師がNG医師リストに含まれていないこと。希望時間帯が診療可能時間内であること。

---

## 12. ログ・監査要件

### 12-1. アプリケーションログ
- **ログレベル**: DEBUG, INFO, WARNING, ERROR
- **ログ出力先**: クラウド上のログストレージまたはファイル（ログローテーション対応）
- **ログ保持期間**: 30日間
- **ログ内容**: タイムスタンプ、ログレベル、メッセージ、スタックトレース（エラー時）

### 12-2. 監査ログ
- **記録対象**: セキュリティ要件 4-3 参照
- **ログ形式**: 構造化データ（JSON形式）
- **ログ保存**: 暗号化されたSQLiteデータベース
- **ログ参照**: 管理者画面から検索・表示可能
- **ログエクスポート**: CSV形式でエクスポート可能（監査用）

---

## 付録: 用語定義

| 用語 | 定義 |
|------|------|
| 往診 | 医師が患者宅を訪問して診療行為を行うこと |
| 管制塔 | 全医師のスケジュール管理・最適化計算を一元管理する機能（本システムでは医師が自ら利用する想定） |
| NG医師 | 患者ごとに設定する「割り当て禁止医師」。その患者には絶対に割り当てない。 |
| 希望訪問時間帯 | 患者の「この時間で来ないといけない」希望。到着時刻がその時間帯内に収まるようにする。 |
| 終了時間の平準化 | 全医師の診療終了時刻をなるべく同じにすること。負荷の偏りを防ぐ。 |
| PoC | Proof of Concept（概念実証）。3月の実運用検証を指す |
| 緊急割り込み | 予定外に新たに発生した往診依頼 |
| ルート最適化 | 複数地点を効率的に巡回する順序を決定するプロセス。可能なら地図上の経路も生成する。 |
| SQLCipher | SQLiteデータベースを暗号化する拡張ライブラリ |
| 監査ログ | システム操作の記録。セキュリティとコンプライアンスのために使用 |

---

## 付録: データモデル（概念図）

### テーブル構成
- **patients**: 患者情報テーブル
  - patient_id (PRIMARY KEY)
  - encrypted_name (暗号化された氏名)
  - latitude, longitude (住所の緯度経度)
  - encrypted_address (暗号化された住所文字列、任意)
  - encrypted_phone (暗号化された電話番号、任意)
  - estimated_time (診察推定時間、分)
  - assigned_doctor_id (担当医師ID)
  - created_at, updated_at

- **patient_ng_doctors**: 患者ごとのNG医師（割り当て禁止）テーブル
  - patient_id (FK), doctor_id (FK)
  - 同一 (patient_id, doctor_id) は1件のみ

- **patient_visit_windows**: 患者の希望訪問時間帯テーブル（任意）
  - patient_id (FK)
  - preferred_start_time (希望開始時刻)、preferred_end_time (希望終了時刻) または time_slot_id
  - 1患者あたり1レコード想定（複数時間帯は将来拡張）

- **doctors**: 医師情報テーブル
  - doctor_id (PRIMARY KEY)
  - doctor_name
  - current_latitude, current_longitude (現在地)
  - created_at, updated_at

- **route_calculations**: ルート計算履歴テーブル
  - calculation_id (PRIMARY KEY)
  - calculation_datetime
  - user_name (実行ユーザー)
  - result_json (計算結果のJSON)
  - created_at

- **audit_logs**: 監査ログテーブル
  - log_id (PRIMARY KEY)
  - operation_datetime
  - user_name
  - operation_type (操作種別)
  - target_type (対象データ種別: patient/doctor等)
  - target_id (対象データのID)
  - operation_details (操作詳細、JSON形式)
  - created_at

---

## 付録: セキュリティチェックリスト

### 実装時確認項目
- [ ] SQLCipherによるデータベース暗号化が有効
- [ ] 機密情報カラムの個別暗号化が実装されている
- [ ] マスターパスワードの安全な管理（環境変数または暗号化設定ファイル）
- [ ] ファイルシステム権限の適切な設定
- [ ] 監査ログの記録がすべての重要操作で実施されている
- [ ] バックアップファイルも暗号化されている
- [ ] エラーメッセージに機密情報が含まれていない
- [ ] 入力値のサニタイゼーションが実施されている
- [ ] SQLインジェクション対策（パラメータ化クエリ使用）
- [ ] ログファイルに機密情報が出力されていない
